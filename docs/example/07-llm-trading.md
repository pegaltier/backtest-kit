# LLM –¢—Ä–µ–π–¥–∏–Ω–≥ —Å–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º JSON –≤—ã–≤–æ–¥–æ–º

–≠—Ç–æ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –æ–±—ä—è—Å–Ω—è–µ—Ç, –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ–ª—å—à–∏–µ —è–∑—ã–∫–æ–≤—ã–µ –º–æ–¥–µ–ª–∏ (LLM) –Ω–∞–ø—Ä—è–º—É—é –≤ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏—è—Ö –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–∏–≥–Ω–∞–ª–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏. –í—ã —É–∑–Ω–∞–µ—Ç–µ, –∫–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å Ollama –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ JSON –≤—ã–≤–æ–¥–∞ –∏ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å AI –∞–Ω–∞–ª–∏–∑ –≤ –ø—Ä–æ—Ü–µ—Å—Å –ø—Ä–∏–Ω—è—Ç–∏—è —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ä–µ—à–µ–Ω–∏–π.

## –ß—Ç–æ —Ç–∞–∫–æ–µ LLM —Ç—Ä–µ–π–¥–∏–Ω–≥?

LLM —Ç—Ä–µ–π–¥–∏–Ω–≥ - —ç—Ç–æ –ø–æ–¥—Ö–æ–¥, –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–º –±–æ–ª—å—à–∞—è —è–∑—ã–∫–æ–≤–∞—è –º–æ–¥–µ–ª—å –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ä—ã–Ω–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–æ—Ä–≥–æ–≤—ã–µ —Å–∏–≥–Ω–∞–ª—ã –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏. –í –æ—Ç–ª–∏—á–∏–µ –æ—Ç —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω—ã—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏, LLM –º–æ–∂–µ—Ç –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–≤–æ–π –∞–Ω–∞–ª–∏–∑ –∫ –º–µ–Ω—è—é—â–∏–º—Å—è —Ä—ã–Ω–æ—á–Ω—ã–º —É—Å–ª–æ–≤–∏—è–º.

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ LLM —Ç—Ä–µ–π–¥–∏–Ω–≥–∞

- üß† **–ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å** - –º–æ–¥–µ–ª—å –º–æ–∂–µ—Ç —É—á–∏—Ç—ã–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ –Ω—é–∞–Ω—Å—ã —Ä—ã–Ω–∫–∞
- üìä **–ú—É–ª—å—Ç–∏—Ñ–∞–∫—Ç–æ—Ä–Ω—ã–π –∞–Ω–∞–ª–∏–∑** - –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –¥–µ—Å—è—Ç–∫–æ–≤ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤
- üîÑ **–ù–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ** - –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–æ–æ–±—É—á–µ–Ω–∏—è –Ω–∞ –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- üí° **–û–±—ä—è—Å–Ω–∏–º–æ—Å—Ç—å** - –º–æ–¥–µ–ª—å –º–æ–∂–µ—Ç –æ–±—ä—è—Å–Ω–∏—Ç—å –ø—Ä–∏—á–∏–Ω—ã —Å–≤–æ–∏—Ö —Ä–µ—à–µ–Ω–∏–π
- ‚ö° **–ë—ã—Å—Ç—Ä–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è** - –ª–µ–≥–∫–æ –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é —á–µ—Ä–µ–∑ –ø—Ä–æ–º–ø—Ç

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ LLM —Ç—Ä–µ–π–¥–∏–Ω–≥–∞

```mermaid
graph TB
    subgraph "–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö"
        Candles["–°–≤–µ—á–∏<br/>1m, 5m, 15m, 30m, 1h"]
        Indicators["–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã<br/>RSI, MACD, BB, ADX"]
        Support["–£—Ä–æ–≤–Ω–∏<br/>–ü–æ–¥–¥–µ—Ä–∂–∫–∞/–°–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ"]
        Volume["–û–±—ä–µ–º—ã<br/>–ê–Ω–∞–ª–∏–∑ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏"]
    end

    subgraph "–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞"
        Messages["–ú–∞—Å—Å–∏–≤ —Å–æ–æ–±—â–µ–Ω–∏–π<br/>user + assistant"]
        Context["–ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è LLM<br/>–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑"]
    end

    subgraph "LLM –û–±—Ä–∞–±–æ—Ç–∫–∞"
        Ollama["Ollama API<br/>deepseek-v3.1"]
        Schema["JSON Schema<br/>–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–∏–≥–Ω–∞–ª–∞"]
        Validation["–í–∞–ª–∏–¥–∞—Ü–∏—è<br/>format parameter"]
    end

    subgraph "–¢–æ—Ä–≥–æ–≤—ã–π —Å–∏–≥–Ω–∞–ª"
        Signal["–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π JSON<br/>position, priceOpen,<br/>priceTakeProfit,<br/>priceStopLoss,<br/>minuteEstimatedTime"]
        Execute["–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ<br/>Backtest/Live"]
    end

    Candles --> Messages
    Indicators --> Messages
    Support --> Messages
    Volume --> Messages

    Messages --> Context
    Context --> Ollama

    Ollama --> Schema
    Schema --> Validation
    Validation --> Signal

    Signal --> Execute

    style Ollama fill:#e1ffe1
    style Signal fill:#ffe1e1
    style Execute fill:#e1f5ff
```

---

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Ollama –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞

### –®–∞–≥ 1: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Ollama (–µ—Å–ª–∏ –µ—â–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
# Windows
winget install Ollama.Ollama

# macOS
brew install ollama

# Linux
curl -fsSL https://ollama.ai/install.sh | sh
```

```bash
# –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
ollama serve

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–æ–¥–µ–ª–∏ deepseek-v3.1 (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è —Ç—Ä–µ–π–¥–∏–Ω–≥–∞)
ollama pull deepseek-v3.1
```

### –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
# .env —Ñ–∞–π–ª
OLLAMA_HOST=http://localhost:11434
OLLAMA_MODEL=deepseek-v3.1

# –î–ª—è –æ–±–ª–∞—á–Ω–æ–≥–æ Ollama
OLLAMA_API_KEY=your_api_key_here
OLLAMA_HOST=https://ollama.com
```

---

## –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ JSON –≤—ã–≤–æ–¥–∞

### –ë–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

```typescript
import { Ollama } from "ollama";

async function json(messages) {
  const ollama = new Ollama({
    host: process.env.OLLAMA_HOST || "http://localhost:11434",
  });

  const response = await ollama.chat({
    model: process.env.OLLAMA_MODEL || "deepseek-v3.1",
    messages: [
      {
        role: "system",
        content: [
          "–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ç–æ—Ä–≥–æ–≤—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –∏ –≤–µ—Ä–Ω–∏ —Ç–æ—Ä–≥–æ–≤—ã–π —Å–∏–≥–Ω–∞–ª.",
          "",
          "–ü–†–ê–í–ò–õ–ê –û–¢–ö–†–´–¢–ò–Ø –ü–û–ó–ò–¶–ò–ô:",
          "",
          "1. –¢–ò–ü–´ –ü–û–ó–ò–¶–ò–ô:",
          "   - position='wait': –Ω–µ—Ç —á–µ—Ç–∫–æ–≥–æ —Å–∏–≥–Ω–∞–ª–∞, –∂–¥–∏ –ª—É—á—à–∏—Ö —É—Å–ª–æ–≤–∏–π",
          "   - position='long': –±—ã—á–∏–π —Å–∏–≥–Ω–∞–ª, —Ü–µ–Ω–∞ –±—É–¥–µ—Ç —Ä–∞—Å—Ç–∏",
          "   - position='short': –º–µ–¥–≤–µ–∂–∏–π —Å–∏–≥–Ω–∞–ª, —Ü–µ–Ω–∞ –±—É–¥–µ—Ç –ø–∞–¥–∞—Ç—å",
          "",
          "2. –¶–ï–ù–ê –í–•–û–î–ê (priceOpen):",
          "   - –ú–æ–∂–µ—Ç –±—ã—Ç—å —Ç–µ–∫—É—â–µ–π —Ä—ã–Ω–æ—á–Ω–æ–π —Ü–µ–Ω–æ–π –¥–ª—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –≤—Ö–æ–¥–∞",
          "   - –ú–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–π —Ü–µ–Ω–æ–π –¥–ª—è –≤—Ö–æ–¥–∞ –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ —É—Ä–æ–≤–Ω—è",
          "   - –£–∫–∞–∂–∏ –æ–ø—Ç–∏–º–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –≤—Ö–æ–¥–∞ —Å–æ–≥–ª–∞—Å–Ω–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞",
          "",
          "3. –£–†–û–í–ù–ò –í–´–•–û–î–ê:",
          "   - LONG: priceTakeProfit > priceOpen > priceStopLoss",
          "   - SHORT: priceStopLoss > priceOpen > priceTakeProfit",
          "   - –£—Ä–æ–≤–Ω–∏ –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ (Fibonacci, S/R, Bollinger)",
          "",
          "4. –í–†–ï–ú–ï–ù–ù–´–ï –†–ê–ú–ö–ò:",
          "   - minuteEstimatedTime: –ø—Ä–æ–≥–Ω–æ–∑ –≤—Ä–µ–º–µ–Ω–∏ –¥–æ TP (–º–∞–∫—Å 360 –º–∏–Ω—É—Ç)",
          "   - –†–∞—Å—á–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ ATR, ADX, MACD, Momentum, Slope",
        ].join("\n"),
      },
      ...messages,
    ],
    format: {
      type: "object",
      properties: {
        position: {
          type: "string",
          enum: ["wait", "long", "short"],
          description: "Trade decision: wait (no signal), long (buy), or short (sell)",
        },
        note: {
          type: "string",
          description: "Professional trading recommendation with price levels",
        },
        priceOpen: {
          type: "number",
          description: "Entry price (current market price or limit order price)",
        },
        priceTakeProfit: {
          type: "number",
          description: "Take profit target price",
        },
        priceStopLoss: {
          type: "number",
          description: "Stop loss exit price",
        },
        minuteEstimatedTime: {
          type: "number",
          description: "Expected time to reach TP in minutes (max 360)",
        },
      },
      required: [
        "position",
        "note",
        "priceOpen",
        "priceTakeProfit",
        "priceStopLoss",
        "minuteEstimatedTime"
      ],
    },
  });

  const jsonResponse = JSON.parse(response.message.content.trim());
  return jsonResponse;
}

export default json;
```

---

## –ú—É–ª—å—Ç–∏—Ç–∞–π–º—Ñ—Ä–µ–π–º–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑

### –ü–∞—Ç—Ç–µ—Ä–Ω –∞–Ω–∞–ª–∏–∑–∞ —Ä–∞–∑–Ω—ã—Ö —Ç–∞–π–º—Ñ—Ä–µ–π–º–æ–≤

```typescript
import ccxt from "ccxt";
import { json } from "./utils/json.mjs";

async function analyzeMultipleTimeframes(symbol) {
  const exchange = new ccxt.binance();
  const messages = [];

  // 1. –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Ä–∞–∑–Ω—ã—Ö —Ç–∞–π–º—Ñ—Ä–µ–π–º–æ–≤
  const candles1h = await exchange.fetchOHLCV(symbol, "1h", undefined, 24);
  const candles15m = await exchange.fetchOHLCV(symbol, "15m", undefined, 48);
  const candles5m = await exchange.fetchOHLCV(symbol, "5m", undefined, 60);
  const candles1m = await exchange.fetchOHLCV(symbol, "1m", undefined, 60);

  // 2. –ê–Ω–∞–ª–∏–∑ 1-—á–∞—Å–æ–≤–æ–≥–æ —Ç—Ä–µ–Ω–¥–∞
  messages.push({
    role: "user",
    content: `–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π 1-—á–∞—Å–æ–≤—ã–µ —Å–≤–µ—á–∏ –¥–ª—è ${symbol}:\n` +
      formatCandles(candles1h) +
      `\n\n–û–ø—Ä–µ–¥–µ–ª–∏ –æ—Å–Ω–æ–≤–Ω–æ–π —Ç—Ä–µ–Ω–¥ (–≤–æ—Å—Ö–æ–¥—è—â–∏–π/–Ω–∏—Å—Ö–æ–¥—è—â–∏–π/–±–æ–∫–æ–≤–æ–π).`
  });

  messages.push({
    role: "assistant",
    content: "–¢—Ä–µ–Ω–¥ 1h –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –û–ø—Ä–µ–¥–µ–ª–µ–Ω –æ—Å–Ω–æ–≤–Ω–æ–π —Ç—Ä–µ–Ω–¥ –∏ –∫–ª—é—á–µ–≤—ã–µ —É—Ä–æ–≤–Ω–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏/—Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏—è."
  });

  // 3. –ê–Ω–∞–ª–∏–∑ 15-–º–∏–Ω—É—Ç–Ω–æ–≥–æ —Ç—Ä–µ–Ω–¥–∞
  messages.push({
    role: "user",
    content: `–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π 15-–º–∏–Ω—É—Ç–Ω—ã–µ —Å–≤–µ—á–∏ –¥–ª—è ${symbol}:\n` +
      formatCandles(candles15m) +
      `\n\n–û–ø—Ä–µ–¥–µ–ª–∏ –∫—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–π —Ç—Ä–µ–Ω–¥ –∏ –¥–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏–∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤.`
  });

  messages.push({
    role: "assistant",
    content: "–¢—Ä–µ–Ω–¥ 15m –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –í—ã—è–≤–ª–µ–Ω—ã –∫—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã."
  });

  // 4. –ê–Ω–∞–ª–∏–∑ 5-–º–∏–Ω—É—Ç–Ω–æ–≥–æ —Ç—Ä–µ–Ω–¥–∞
  messages.push({
    role: "user",
    content: `–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π 5-–º–∏–Ω—É—Ç–Ω—ã–µ —Å–≤–µ—á–∏ –¥–ª—è ${symbol}:\n` +
      formatCandles(candles5m) +
      `\n\n–û–ø—Ä–µ–¥–µ–ª–∏ —Ç–æ—á–∫–∏ –≤—Ö–æ–¥–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤.`
  });

  messages.push({
    role: "assistant",
    content: "–¢—Ä–µ–Ω–¥ 5m –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –û–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —Ç–æ—á–∫–∏ –≤—Ö–æ–¥–∞."
  });

  // 5. –ê–Ω–∞–ª–∏–∑ 1-–º–∏–Ω—É—Ç–Ω–æ–π –º–∏–∫—Ä–æ—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
  messages.push({
    role: "user",
    content: `–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π 1-–º–∏–Ω—É—Ç–Ω—ã–µ —Å–≤–µ—á–∏ –¥–ª—è ${symbol}:\n` +
      formatCandles(candles1m) +
      `\n\n–û–ø—Ä–µ–¥–µ–ª–∏ –æ–ø—Ç–∏–º–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –≤—Ö–æ–¥–∞ –∏ —É—Ä–æ–≤–Ω–∏ –≤—ã—Ö–æ–¥–∞.`
  });

  messages.push({
    role: "assistant",
    content: "–ú–∏–∫—Ä–æ—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ 1m –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞. –ì–æ—Ç–æ–≤ –∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–∏–≥–Ω–∞–ª–∞."
  });

  // 6. –§–∏–Ω–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Å–∏–≥–Ω–∞–ª–∞
  messages.push({
    role: "user",
    content: [
      `–ù–∞ –æ—Å–Ω–æ–≤–µ –≤—Å–µ—Ö –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–∞–π–º—Ñ—Ä–µ–π–º–æ–≤, —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π —Ç–æ—Ä–≥–æ–≤—ã–π —Å–∏–≥–Ω–∞–ª –¥–ª—è ${symbol}.`,
      "",
      "–£—á—Ç–∏:",
      "1. –û—Å–Ω–æ–≤–Ω–æ–π —Ç—Ä–µ–Ω–¥ —Å 1h",
      "2. –ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã —Å 15m –∏ 5m",
      "3. –¢–æ—á–Ω—É—é —Ü–µ–Ω—É –≤—Ö–æ–¥–∞ —Å 1m",
      "4. –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —É—Ä–æ–≤–Ω–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏/—Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏—è",
      "5. –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Ä–∏—Å–∫/–ø—Ä–∏–±—ã–ª—å –º–∏–Ω–∏–º—É–º 1:2",
    ].join("\n")
  });

  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ JSON —Å–∏–≥–Ω–∞–ª–∞
  const signal = await json(messages);

  return signal;
}

function formatCandles(candles) {
  return candles.map(([timestamp, open, high, low, close, volume]) => {
    const date = new Date(timestamp).toISOString();
    return `${date} | O:${open} H:${high} L:${low} C:${close} V:${volume}`;
  }).join('\n');
}
```

---

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Backtest-Kit

### –ü–æ–ª–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è —Å LLM

```typescript
import { addStrategy, Backtest } from "backtest-kit";
import { json } from "./utils/json.mjs";
import ccxt from "ccxt";

// –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è LLM-—Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
addStrategy({
  strategyName: "llm-trading-strategy",
  interval: "5m",
  getSignal: async (symbol) => {
    const exchange = new ccxt.binance();
    const messages = [];

    // 1. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∞–π–º—Ñ—Ä–µ–π–º–æ–≤
    const candles1h = await exchange.fetchOHLCV(symbol, "1h", undefined, 24);
    const candles15m = await exchange.fetchOHLCV(symbol, "15m", undefined, 24);
    const candles5m = await exchange.fetchOHLCV(symbol, "5m", undefined, 24);
    const candles1m = await exchange.fetchOHLCV(symbol, "1m", undefined, 30);

    // 2. –†–∞—Å—á–µ—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤
    const indicators = calculateIndicators(candles5m);

    // 3. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è LLM
    messages.push({
      role: "user",
      content: `–ê–Ω–∞–ª–∏–∑ ${symbol}:\n\n` +
        `## 1-—á–∞—Å–æ–≤–æ–π —Ç—Ä–µ–Ω–¥:\n${formatTrendAnalysis(candles1h)}\n\n` +
        `## 15-–º–∏–Ω—É—Ç–Ω—ã–π —Ç—Ä–µ–Ω–¥:\n${formatTrendAnalysis(candles15m)}\n\n` +
        `## 5-–º–∏–Ω—É—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞–º–∏:\n${formatIndicators(indicators)}\n\n` +
        `## 1-–º–∏–Ω—É—Ç–Ω–∞—è –º–∏–∫—Ä–æ—Å—Ç—Ä—É–∫—Ç—É—Ä–∞:\n${formatMicrostructure(candles1m)}\n\n` +
        `–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞: ${candles5m[candles5m.length - 1][4]}`
    });

    // 4. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–∏–≥–Ω–∞–ª–∞
    const signal = await json(messages);

    // 5. –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –≤–æ–∑–≤—Ä–∞—Ç
    if (signal.position === "wait") {
      return null;  // –ù–µ—Ç —Å–∏–≥–Ω–∞–ª–∞
    }

    return {
      position: signal.position,
      priceOpen: signal.priceOpen,
      priceTakeProfit: signal.priceTakeProfit,
      priceStopLoss: signal.priceStopLoss,
      minuteEstimatedTime: signal.minuteEstimatedTime,
      timestamp: Date.now(),
      note: signal.note,  // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç LLM
    };
  },
});

// –ó–∞–ø—É—Å–∫ –±—ç–∫—Ç–µ—Å—Ç–∞
for await (const result of Backtest.run("BTCUSDT", {
  strategyName: "llm-trading-strategy",
  exchangeName: "binance",
  frameName: "december-2025",
})) {
  if (result.action === "closed") {
    console.log(`–°–∏–≥–Ω–∞–ª –∑–∞–∫—Ä—ã—Ç: ${result.closeReason}`);
    console.log(`PNL: ${result.pnl.pnlPercentage.toFixed(2)}%`);
    console.log(`–ó–∞–º–µ—Ç–∫–∞: ${result.signal.note}`);
  }
}
```

---

## –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π JSON Schema –¥–ª—è —Ç–æ—Ä–≥–æ–≤—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤

### –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ö–µ–º–∞ —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ –ø–æ–ª—è–º–∏

```typescript
async function jsonAdvanced(messages) {
  const ollama = new Ollama({
    host: process.env.OLLAMA_HOST || "http://localhost:11434",
  });

  const response = await ollama.chat({
    model: process.env.OLLAMA_MODEL || "deepseek-v3.1",
    messages,
    format: {
      type: "object",
      properties: {
        position: {
          type: "string",
          enum: ["wait", "long", "short"],
          description: "–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏",
        },
        confidence: {
          type: "number",
          minimum: 0,
          maximum: 100,
          description: "–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ —Å–∏–≥–Ω–∞–ª–µ (0-100%)",
        },
        priceOpen: {
          type: "number",
          description: "–¶–µ–Ω–∞ –≤—Ö–æ–¥–∞",
        },
        priceTakeProfit: {
          type: "number",
          description: "–¶–µ–Ω–∞ —Ç–µ–π–∫-–ø—Ä–æ—Ñ–∏—Ç–∞",
        },
        priceStopLoss: {
          type: "number",
          description: "–¶–µ–Ω–∞ —Å—Ç–æ–ø-–ª–æ—Å—Å–∞",
        },
        minuteEstimatedTime: {
          type: "number",
          minimum: 1,
          maximum: 360,
          description: "–û–∂–∏–¥–∞–µ–º–æ–µ –≤—Ä–µ–º—è –¥–æ TP –≤ –º–∏–Ω—É—Ç–∞—Ö",
        },
        reasoning: {
          type: "string",
          description: "–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ —Ä–µ—à–µ–Ω–∏—è",
        },
        technicalLevels: {
          type: "object",
          properties: {
            support: {
              type: "array",
              items: { type: "number" },
              description: "–£—Ä–æ–≤–Ω–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏",
            },
            resistance: {
              type: "array",
              items: { type: "number" },
              description: "–£—Ä–æ–≤–Ω–∏ —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏—è",
            },
          },
          description: "–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —É—Ä–æ–≤–Ω–∏",
        },
        indicators: {
          type: "object",
          properties: {
            rsi: { type: "number", description: "–ó–Ω–∞—á–µ–Ω–∏–µ RSI" },
            macd: { type: "string", description: "–°–æ—Å—Ç–æ—è–Ω–∏–µ MACD (bullish/bearish)" },
            trend: { type: "string", description: "–û—Å–Ω–æ–≤–Ω–æ–π —Ç—Ä–µ–Ω–¥" },
            volume: { type: "string", description: "–ê–Ω–∞–ª–∏–∑ –æ–±—ä–µ–º–∞" },
          },
          description: "–°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤",
        },
        riskReward: {
          type: "number",
          description: "–°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Ä–∏—Å–∫/–ø—Ä–∏–±—ã–ª—å",
        },
        marketContext: {
          type: "string",
          enum: ["trending", "ranging", "volatile", "breakout"],
          description: "–ö–æ–Ω—Ç–µ–∫—Å—Ç —Ä—ã–Ω–∫–∞",
        },
      },
      required: [
        "position",
        "confidence",
        "priceOpen",
        "priceTakeProfit",
        "priceStopLoss",
        "minuteEstimatedTime",
        "reasoning",
        "riskReward",
        "marketContext"
      ],
    },
  });

  return JSON.parse(response.message.content.trim());
}
```

---

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ –¥–ª—è LLM

### –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

```typescript
import { RSI, MACD, BollingerBands, ADX } from "technicalindicators";

function calculateIndicators(candles) {
  const closes = candles.map(c => c[4]);
  const highs = candles.map(c => c[2]);
  const lows = candles.map(c => c[3]);

  return {
    rsi: RSI.calculate({ period: 14, values: closes }),
    macd: MACD.calculate({
      values: closes,
      fastPeriod: 12,
      slowPeriod: 26,
      signalPeriod: 9,
      SimpleMAOscillator: false,
      SimpleMASignal: false,
    }),
    bb: BollingerBands.calculate({
      period: 20,
      values: closes,
      stdDev: 2,
    }),
    adx: ADX.calculate({
      high: highs,
      low: lows,
      close: closes,
      period: 14,
    }),
  };
}

function formatIndicators(indicators) {
  const latest = {
    rsi: indicators.rsi[indicators.rsi.length - 1],
    macd: indicators.macd[indicators.macd.length - 1],
    bb: indicators.bb[indicators.bb.length - 1],
    adx: indicators.adx[indicators.adx.length - 1],
  };

  return [
    `RSI(14): ${latest.rsi?.toFixed(2) || 'N/A'}`,
    `MACD: ${latest.macd?.MACD?.toFixed(4) || 'N/A'}`,
    `MACD Signal: ${latest.macd?.signal?.toFixed(4) || 'N/A'}`,
    `MACD Histogram: ${latest.macd?.histogram?.toFixed(4) || 'N/A'}`,
    `BB Upper: ${latest.bb?.upper?.toFixed(2) || 'N/A'}`,
    `BB Middle: ${latest.bb?.middle?.toFixed(2) || 'N/A'}`,
    `BB Lower: ${latest.bb?.lower?.toFixed(2) || 'N/A'}`,
    `ADX: ${latest.adx?.adx?.toFixed(2) || 'N/A'}`,
    `+DI: ${latest.adx?.pdi?.toFixed(2) || 'N/A'}`,
    `-DI: ${latest.adx?.mdi?.toFixed(2) || 'N/A'}`,
  ].join('\n');
}

function formatTrendAnalysis(candles) {
  const closes = candles.map(c => c[4]);
  const trend = closes[closes.length - 1] > closes[0] ? "–í–æ—Å—Ö–æ–¥—è—â–∏–π" : "–ù–∏—Å—Ö–æ–¥—è—â–∏–π";
  const changePercent = ((closes[closes.length - 1] - closes[0]) / closes[0] * 100).toFixed(2);

  return [
    `–¢—Ä–µ–Ω–¥: ${trend}`,
    `–ò–∑–º–µ–Ω–µ–Ω–∏–µ: ${changePercent}%`,
    `–ú–∞–∫—Å–∏–º—É–º: ${Math.max(...candles.map(c => c[2])).toFixed(2)}`,
    `–ú–∏–Ω–∏–º—É–º: ${Math.min(...candles.map(c => c[3])).toFixed(2)}`,
  ].join('\n');
}

function formatMicrostructure(candles) {
  const latest = candles[candles.length - 1];
  const [timestamp, open, high, low, close, volume] = latest;

  return [
    `–ü–æ—Å–ª–µ–¥–Ω—è—è —Å–≤–µ—á–∞:`,
    `Open: ${open}`,
    `High: ${high}`,
    `Low: ${low}`,
    `Close: ${close}`,
    `Volume: ${volume}`,
    `Body: ${Math.abs(close - open).toFixed(2)}`,
    `Wick Upper: ${(high - Math.max(open, close)).toFixed(2)}`,
    `Wick Lower: ${(Math.min(open, close) - low).toFixed(2)}`,
  ].join('\n');
}
```

---

## –¢–µ–∫—Å—Ç–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑ —Å Ollama

### –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞

```typescript
import { Ollama } from "ollama";

async function text(symbol, messages) {
  const ollama = new Ollama({
    host: process.env.OLLAMA_HOST || "http://localhost:11434",
  });

  const response = await ollama.chat({
    model: "deepseek-v3.1",
    think: true,  // –í–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–π
    messages: [
      {
        role: "system",
        content: [
          "–¢—ã - –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç—Ä–µ–π–¥–µ—Ä —Å 10+ –ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º.",
          "–ê–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ä—ã–Ω–æ–∫ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –∏ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ã—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤.",
          "–î–∞–≤–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —Å —É—Ä–æ–≤–Ω—è–º–∏ –≤—Ö–æ–¥–∞ –∏ –≤—ã—Ö–æ–¥–∞.",
          "",
          "**–í–ê–ñ–ù–û**: –ü–∏—à–∏ —Ç–æ–ª—å–∫–æ –∞–Ω–∞–ª–∏–∑, –±–µ–∑ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π!",
        ].join("\n"),
      },
      {
        role: "system",
        content: "Reasoning: high",  // –í—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–π
      },
      ...messages,
      {
        role: "user",
        content: [
          `–ù–∞ –∫–∞–∫–∏—Ö —É—Å–ª–æ–≤–∏—è—Ö –º–Ω–µ –∫—É–ø–∏—Ç—å/–ø—Ä–æ–¥–∞—Ç—å ${symbol}?`,
          "",
          "–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π:",
          "1. –£—Ä–æ–≤–Ω–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏/—Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏—è",
          "2. –¢–æ—á–∫–∏ –≤—Ö–æ–¥–∞ –≤ LONG/SHORT –ø–æ–∑–∏—Ü–∏–∏",
          "3. –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Ä–∏—Å–∫/–ø—Ä–∏–±—ã–ª—å",
          "4. –ü—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (LONG –∏–ª–∏ SHORT)",
          "",
          "–î–∞–π —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–æ–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–µ–π.",
        ].join("\n"),
      },
    ],
  });

  return response.message.content.trim();
}

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
const analysis = await text("BTCUSDT", [
  {
    role: "user",
    content: "–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞ BTC: $95,000. RSI: 65. MACD –±—ã—á–∏–π."
  }
]);

console.log(analysis);
```

---

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç–ª–∞–¥–∫–∞ LLM —Å–∏–≥–Ω–∞–ª–æ–≤

### –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏

```typescript
import fs from "fs/promises";

async function dumpJson(signalId, messages, result) {
  const timestamp = new Date().toISOString().replace(/:/g, '-');
  const filename = `./logs/llm-signals/${signalId}_${timestamp}.json`;

  const logData = {
    signalId,
    timestamp,
    messages,
    result,
    metadata: {
      model: process.env.OLLAMA_MODEL,
      host: process.env.OLLAMA_HOST,
    },
  };

  await fs.mkdir("./logs/llm-signals", { recursive: true });
  await fs.writeFile(filename, JSON.stringify(logData, null, 2));

  console.log(`LLM —Å–∏–≥–Ω–∞–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω: ${filename}`);
}

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
addStrategy({
  strategyName: "llm-with-logging",
  interval: "5m",
  getSignal: async (symbol) => {
    const messages = buildMessages(symbol);
    const signal = await json(messages);

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    await dumpJson(`${symbol}-${Date.now()}`, messages, signal);

    if (signal.position === "wait") {
      return null;
    }

    return signal;
  },
});
```

---

## –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –ø—Ä–∏–º–µ—Ä: –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è

### LLM + –¢—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã

```typescript
import { addStrategy } from "backtest-kit";
import { json } from "./utils/json.mjs";
import { RSI, MACD } from "technicalindicators";
import ccxt from "ccxt";

addStrategy({
  strategyName: "hybrid-llm-strategy",
  interval: "5m",
  getSignal: async (symbol) => {
    const exchange = new ccxt.binance();

    // 1. –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
    const candles5m = await exchange.fetchOHLCV(symbol, "5m", undefined, 100);
    const closes = candles5m.map(c => c[4]);

    // 2. –†–∞—Å—á–µ—Ç —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω—ã—Ö –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤
    const rsi = RSI.calculate({ period: 14, values: closes });
    const macd = MACD.calculate({
      values: closes,
      fastPeriod: 12,
      slowPeriod: 26,
      signalPeriod: 9,
      SimpleMAOscillator: false,
      SimpleMASignal: false,
    });

    const currentRSI = rsi[rsi.length - 1];
    const currentMACD = macd[macd.length - 1];

    // 3. –ë—ã—Å—Ç—Ä–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è —É—Å–ª–æ–≤–∏–π
    // –ï—Å–ª–∏ RSI –≤ –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ–π –∑–æ–Ω–µ –∏ –Ω–µ—Ç —á–µ—Ç–∫–æ–≥–æ —Ç—Ä–µ–Ω–¥–∞ - –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å
    if (currentRSI > 40 && currentRSI < 60 && Math.abs(currentMACD?.MACD || 0) < 10) {
      return null;  // –ù–µ —Ç—Ä–∞—Ç–∏—Ç—å —Ç–æ–∫–µ–Ω—ã LLM –Ω–∞ –Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ —Å–∏—Ç—É–∞—Ü–∏–∏
    }

    // 4. LLM –∞–Ω–∞–ª–∏–∑ —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤
    const messages = [
      {
        role: "user",
        content: `–ê–Ω–∞–ª–∏–∑ ${symbol}:\n\n` +
          `–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞: ${closes[closes.length - 1]}\n` +
          `RSI(14): ${currentRSI.toFixed(2)}\n` +
          `MACD: ${currentMACD?.MACD?.toFixed(4)}\n` +
          `MACD Signal: ${currentMACD?.signal?.toFixed(4)}\n` +
          `MACD Histogram: ${currentMACD?.histogram?.toFixed(4)}\n\n` +
          `–ü–æ—Å–ª–µ–¥–Ω–∏–µ 20 —Å–≤–µ—á–µ–π:\n${formatCandles(candles5m.slice(-20))}`
      }
    ];

    const signal = await json(messages);

    // 5. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è
    if (signal.position === "wait") {
      return null;
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è LLM —Å–∏–≥–Ω–∞–ª–∞ –∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤
    if (signal.position === "long" && currentRSI > 70) {
      console.warn("LLM —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç LONG, –Ω–æ RSI –ø–µ—Ä–µ–∫—É–ø–ª–µ–Ω");
      return null;
    }

    if (signal.position === "short" && currentRSI < 30) {
      console.warn("LLM —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç SHORT, –Ω–æ RSI –ø–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω");
      return null;
    }

    return {
      position: signal.position,
      priceOpen: signal.priceOpen,
      priceTakeProfit: signal.priceTakeProfit,
      priceStopLoss: signal.priceStopLoss,
      minuteEstimatedTime: signal.minuteEstimatedTime,
      timestamp: Date.now(),
      note: `LLM: ${signal.note}\nRSI: ${currentRSI.toFixed(2)}\nMACD: ${currentMACD?.MACD?.toFixed(4)}`,
    };
  },
});
```

---

## –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞—Ç—Ä–∞—Ç –Ω–∞ —Ç–æ–∫–µ–Ω—ã

### –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–Ω–∞–ª–∏–∑–∞

```typescript
const analysisCache = new Map();
const CACHE_TTL = 60000; // 1 –º–∏–Ω—É—Ç–∞

async function getCachedAnalysis(symbol, timeframe) {
  const cacheKey = `${symbol}-${timeframe}-${Math.floor(Date.now() / CACHE_TTL)}`;

  if (analysisCache.has(cacheKey)) {
    console.log(`–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –∫—ç—à –¥–ª—è ${cacheKey}`);
    return analysisCache.get(cacheKey);
  }

  const analysis = await performLLMAnalysis(symbol, timeframe);
  analysisCache.set(cacheKey, analysis);

  // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ –∫—ç—à–∞
  if (analysisCache.size > 100) {
    const firstKey = analysisCache.keys().next().value;
    analysisCache.delete(firstKey);
  }

  return analysis;
}
```

### –ë–∞—Ç—á–∏–Ω–≥ –∑–∞–ø—Ä–æ—Å–æ–≤

```typescript
const pendingRequests = [];
const BATCH_SIZE = 5;
const BATCH_DELAY = 1000; // 1 —Å–µ–∫—É–Ω–¥–∞

async function batchLLMRequest(messages) {
  return new Promise((resolve) => {
    pendingRequests.push({ messages, resolve });

    if (pendingRequests.length >= BATCH_SIZE) {
      processBatch();
    } else {
      setTimeout(processBatch, BATCH_DELAY);
    }
  });
}

async function processBatch() {
  if (pendingRequests.length === 0) return;

  const batch = pendingRequests.splice(0, BATCH_SIZE);

  // –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
  const results = await Promise.all(
    batch.map(({ messages }) => json(messages))
  );

  batch.forEach(({ resolve }, index) => {
    resolve(results[index]);
  });
}
```

---

## –ü–æ–ª–Ω—ã–π —Ä–∞–±–æ—á–∏–π –ø—Ä–∏–º–µ—Ä

```typescript
import { config } from "dotenv";
import {
  setLogger,
  addExchange,
  addStrategy,
  addFrame,
  Backtest,
  listenSignalBacktest,
} from "backtest-kit";
import { json } from "./utils/json.mjs";
import ccxt from "ccxt";
import { RSI, MACD, BollingerBands } from "technicalindicators";

// –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
config();

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–≥–µ—Ä–∞
setLogger({
  log: console.log,
  debug: console.debug,
  info: console.info,
  warn: console.warn,
});

// –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –±–∏—Ä–∂–∏
addExchange({
  exchangeName: "binance",
  getCandles: async (symbol, interval, since, limit) => {
    const exchange = new ccxt.binance();
    const ohlcv = await exchange.fetchOHLCV(
      symbol,
      interval,
      since.getTime(),
      limit
    );
    return ohlcv.map(([timestamp, open, high, low, close, volume]) => ({
      timestamp, open, high, low, close, volume
    }));
  },
  formatPrice: async (symbol, price) => price.toFixed(2),
  formatQuantity: async (symbol, quantity) => quantity.toFixed(8),
});

// –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è LLM —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
addStrategy({
  strategyName: "llm-professional-strategy",
  interval: "5m",
  getSignal: async (symbol) => {
    const exchange = new ccxt.binance();

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    const candles1h = await exchange.fetchOHLCV(symbol, "1h", undefined, 24);
    const candles5m = await exchange.fetchOHLCV(symbol, "5m", undefined, 100);
    const closes = candles5m.map(c => c[4]);

    // –†–∞—Å—á–µ—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤
    const rsi = RSI.calculate({ period: 14, values: closes });
    const macd = MACD.calculate({
      values: closes,
      fastPeriod: 12,
      slowPeriod: 26,
      signalPeriod: 9,
      SimpleMAOscillator: false,
      SimpleMASignal: false,
    });
    const bb = BollingerBands.calculate({
      period: 20,
      values: closes,
      stdDev: 2,
    });

    const currentPrice = closes[closes.length - 1];
    const currentRSI = rsi[rsi.length - 1];
    const currentMACD = macd[macd.length - 1];
    const currentBB = bb[bb.length - 1];

    // –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è LLM
    const messages = [
      {
        role: "user",
        content: [
          `# –¢–æ—Ä–≥–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑ ${symbol}`,
          "",
          `## –¢–µ–∫—É—â–∞—è —Ä—ã–Ω–æ—á–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è`,
          `–¶–µ–Ω–∞: $${currentPrice.toFixed(2)}`,
          "",
          `## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã (5m)`,
          `RSI(14): ${currentRSI.toFixed(2)}`,
          `MACD: ${currentMACD?.MACD?.toFixed(4)}`,
          `MACD Signal: ${currentMACD?.signal?.toFixed(4)}`,
          `MACD Histogram: ${currentMACD?.histogram?.toFixed(4)}`,
          `Bollinger Upper: ${currentBB?.upper?.toFixed(2)}`,
          `Bollinger Middle: ${currentBB?.middle?.toFixed(2)}`,
          `Bollinger Lower: ${currentBB?.lower?.toFixed(2)}`,
          "",
          `## 1-—á–∞—Å–æ–≤–æ–π —Ç—Ä–µ–Ω–¥`,
          formatTrendAnalysis(candles1h),
          "",
          `## –ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–≤–µ—á–µ–π (5m)`,
          formatRecentCandles(candles5m.slice(-10)),
        ].join('\n')
      }
    ];

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–∏–≥–Ω–∞–ª–∞ —á–µ—Ä–µ–∑ LLM
    const signal = await json(messages);

    console.log(`\nLLM –ê–Ω–∞–ª–∏–∑ –¥–ª—è ${symbol}:`);
    console.log(`–ü–æ–∑–∏—Ü–∏—è: ${signal.position}`);
    console.log(`–ó–∞–º–µ—Ç–∫–∞: ${signal.note}`);

    if (signal.position === "wait") {
      return null;
    }

    return {
      position: signal.position,
      priceOpen: signal.priceOpen,
      priceTakeProfit: signal.priceTakeProfit,
      priceStopLoss: signal.priceStopLoss,
      minuteEstimatedTime: signal.minuteEstimatedTime,
      timestamp: Date.now(),
      note: signal.note,
    };
  },
});

// –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ñ—Ä–µ–π–º–∞
addFrame({
  frameName: "test-period",
  interval: "5m",
  startDate: new Date("2025-12-01"),
  endDate: new Date("2025-12-07"),
});

// –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–∏–≥–Ω–∞–ª–æ–≤
listenSignalBacktest((event) => {
  if (event.action === "opened") {
    console.log(`\n‚úì –ü–æ–∑–∏—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∞:`);
    console.log(`  –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: ${event.signal.position}`);
    console.log(`  –í—Ö–æ–¥: ${event.signal.priceOpen}`);
    console.log(`  TP: ${event.signal.priceTakeProfit}`);
    console.log(`  SL: ${event.signal.priceStopLoss}`);
    console.log(`  –ê–Ω–∞–ª–∏–∑ LLM: ${event.signal.note}`);
  }

  if (event.action === "closed") {
    console.log(`\n‚úì –ü–æ–∑–∏—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∞:`);
    console.log(`  –ü—Ä–∏—á–∏–Ω–∞: ${event.closeReason}`);
    console.log(`  PNL: ${event.pnl.pnlPercentage.toFixed(2)}%`);
  }
});

// –ó–∞–ø—É—Å–∫ –±—ç–∫—Ç–µ—Å—Ç–∞
console.log("–ó–∞–ø—É—Å–∫ LLM –±—ç–∫—Ç–µ—Å—Ç–∞...\n");

await Backtest.background("BTCUSDT", {
  strategyName: "llm-professional-strategy",
  exchangeName: "binance",
  frameName: "test-period",
});

console.log("\n–ë—ç–∫—Ç–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!");
```

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

LLM —Ç—Ä–µ–π–¥–∏–Ω–≥ —Å–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º JSON –≤—ã–≤–æ–¥–æ–º –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –Ω–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∞–¥–∞–ø—Ç–∏–≤–Ω—ã—Ö —Ç–æ—Ä–≥–æ–≤—ã—Ö —Å–∏—Å—Ç–µ–º. –ö–æ–º–±–∏–Ω–∏—Ä—É—è –º–æ—â–Ω–æ—Å—Ç—å –±–æ–ª—å—à–∏—Ö —è–∑—ã–∫–æ–≤—ã—Ö –º–æ–¥–µ–ª–µ–π —Å –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å—é —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω—ã—Ö –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤, –≤—ã –º–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –∞–¥–∞–ø—Ç–∏—Ä—É—é—Ç—Å—è –∫ –º–µ–Ω—è—é—â–∏–º—Å—è —Ä—ã–Ω–æ—á–Ω—ã–º —É—Å–ª–æ–≤–∏—è–º.

**–ö–ª—é—á–µ–≤—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞**:
- üéØ –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏ –≤–∞–ª–∏–¥–∏—Ä—É–µ–º—ã–π –≤—ã–≤–æ–¥
- üß† –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Ä—ã–Ω–æ—á–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- üìä –ú—É–ª—å—Ç–∏—Ç–∞–π–º—Ñ—Ä–µ–π–º–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑
- üí° –û–±—ä—è—Å–Ω–∏–º—ã–µ —Ç–æ—Ä–≥–æ–≤—ã–µ —Ä–µ—à–µ–Ω–∏—è
- üîÑ –õ–µ–≥–∫–∞—è –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è —Å—Ç—Ä–∞—Ç–µ–≥–∏–π —á–µ—Ä–µ–∑ –ø—Ä–æ–º–ø—Ç—ã

**–£—Å–ø–µ—à–Ω–æ–≥–æ LLM —Ç—Ä–µ–π–¥–∏–Ω–≥–∞!**
